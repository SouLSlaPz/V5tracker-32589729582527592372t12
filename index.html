<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading P/L Feeder (App A)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=DM+Sans:wght@400;700&family=Exo+2:wght@400;700&family=Fira+Code:wght@400;700&family=IBM+Plex+Mono:wght@400;700&family=Inter:wght@400;700&family=Lato:wght@400;700&family=JetBrains+Mono:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Nunito:wght@400;700&family=Orbitron:wght@400;700&family=Oxanium:wght@400;700&family=Poppins:wght@400;500;600;700&family=Russo+One&family=Roboto+Mono:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLE SYSTEM --- */
        :root {
            --bg-main: #111;
            --text-main: #fff;
            --text-muted: rgba(255,255,255,0.6);
            --border-main: rgba(255,255,255,0.15);
            --color-p: #4ade80; /* Positive */
            --color-n: #f87171; /* Negative */
            --color-a: #3b82f6; /* Accent */
            --btn-text: #ffffff; 
            --glass-bg: rgba(20, 20, 20, 0.7);
            --input-bg: rgba(0, 0, 0, 0.4);
            --font-main: 'Inter', sans-serif;
        }

        /* SMART SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-main); border-radius: 3px; }

        html, body { margin: 0; padding: 0; height: 100%; overscroll-behavior: none; font-family: var(--font-main); }
        
        body { 
            background: var(--bg-main); 
            color: var(--text-main); 
            transition: background 0.3s ease, color 0.3s ease;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
        }

        /* Main Container */
        .main-container { 
            width: 100%; 
            max-width: 440px; 
            margin: auto; 
            display: flex; 
            flex-direction: column; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            height: 95vh; 
            max-height: 900px; 
            background: var(--glass-bg);
            border: 1px solid var(--border-main);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
            position: relative; 
        }

        /* Buttons & Inputs */
        .btn { padding: 0.6rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; border: 1px solid transparent; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-secondary { background: var(--input-bg); border-color: var(--border-main); color: var(--text-main); }
        .btn-secondary:hover { background: var(--border-main); opacity: 1; }
        .btn-action { background: var(--color-a); color: var(--btn-text) !important; box-shadow: 0 4px 12px -2px var(--color-a); }
        .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-negative-action { background: var(--color-n); color: var(--btn-text) !important; }

        .calc-btn { width: 100%; aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; border-radius: 1rem; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; cursor: pointer; position: relative; overflow: hidden; font-family: var(--font-main); }
        .calc-btn:active { transform: scale(0.95); }
        
        .btn-positive { background: var(--color-p); color: var(--btn-text) !important; box-shadow: 0 4px 15px -3px var(--color-p); opacity: 0.9; }
        .btn-negative-calc { background: var(--color-n); color: var(--btn-text) !important; box-shadow: 0 4px 15px -3px var(--color-n); opacity: 0.9; }
        .btn-neutral-calc { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-main); }
        .btn-positive:hover, .btn-negative-calc:hover { opacity: 1; transform: translateY(-1px); }
        .btn-neutral-calc:hover { background: var(--border-main); }

        .form-input, .dropdown { width: 100%; background: var(--input-bg); border: 1px solid var(--border-main); padding: 0.6rem 0.8rem; border-radius: 0.5rem; color: var(--text-main); outline: none; font-family: var(--font-main); cursor: pointer; }
        .form-input:focus, .dropdown:focus { border-color: var(--color-a); }
        select option { background-color: #222; color: white; }
        
        .icon-btn { padding: 0.5rem; border-radius: 0.5rem; color: var(--text-muted); transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: var(--border-main); color: var(--text-main); }

        /* PIN Screen - SOLID BACKGROUND */
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #050505; color: white; transition: opacity 0.5s ease; }
        #pin-overlay.hidden { opacity: 0; pointer-events: none; }
        .pin-input { font-size: 2.5rem; letter-spacing: 0.5rem; text-align: center; width: 240px; background: transparent; border: none; border-bottom: 2px solid var(--color-a); color: white; outline: none; margin-bottom: 2rem; font-family: monospace; }
        
        /* Views */
        .view { display: none; flex-direction: column; height: 100%; padding: 1.5rem; animation: fadeIn 0.3s ease-in-out; overflow-y: auto; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Data Ring */
        .data-ring-container { position: relative; width: 85px; height: 85px; cursor: pointer; }
        .data-ring-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-track { stroke: var(--border-main); opacity: 0.3; }
        .ring-wins { stroke: var(--color-p); transition: stroke-dasharray 0.5s ease; }
        .ring-losses { stroke: var(--color-n); transition: stroke-dasharray 0.5s ease; }
        .data-ring-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; pointer-events: none; }
        .data-ring-total .value { font-size: 1.8rem; font-weight: 800; font-family: 'IBM Plex Mono', monospace; }
        .data-ring-details { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .profit-value { font-size: 1.1rem; font-weight: 800; line-height: 1.1; margin-bottom: 2px; }
        .wl-value { font-size: 0.75rem; font-weight: 600; opacity: 0.8; font-family: var(--font-main); }
        .data-ring-container.show-details .data-ring-total { display: none; }
        .data-ring-container.show-details .data-ring-details { display: flex; }
        
        /* Theme Cards */
        .theme-card { position: relative; cursor: pointer; border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-main); background: var(--input-bg); transition: all 0.2s; }
        .theme-card:hover { transform: translateY(-2px); border-color: var(--color-a); }
        .theme-card.selected { border-color: var(--color-a); box-shadow: 0 0 0 2px var(--color-a); }
        .theme-card-header { display: flex; justify-content: space-between; align-items: center; }
        .theme-swatches { display: flex; gap: 6px; margin-top: 10px; }
        .swatch { width: 20px; height: 20px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); }
        .checkmark-icon { position: absolute; top: 0.75rem; right: 0.75rem; width: 1.5rem; height: 1.5rem; background-color: var(--color-a); color: white; border-radius: 9999px; display: none; align-items: center; justify-content: center; }
        .theme-card.selected .checkmark-icon { display: flex; }

        /* Open Mode Dials */
        .open-mode-container { display: flex; height: 100%; width: 100%; justify-content: space-between; align-items: center; position: relative; touch-action: none; }
        .open-mode-container.hidden { display: none !important; }
        .dial-track-container { width: 80px; height: 260px; position: relative; display: flex; justify-content: center; border-radius: 999px; background: var(--input-bg); border: 1px solid var(--border-main); overflow: visible; }
        .dial-handle { width: 60px; height: 60px; border-radius: 50%; background: var(--text-main); position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--bg-main); font-size: 1.2rem; pointer-events: none; z-index: 10; transition: bottom 0.05s linear; }
        .dial-value-display { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; font-weight: 800; opacity: 0; transition: opacity 0.2s; font-family: 'IBM Plex Mono', monospace; color: var(--text-main); }
        .dial-track-container.active .dial-value-display { opacity: 1; }
        .center-zero-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--input-bg); border: 2px solid var(--border-main); color: var(--text-main); font-size: 1.8rem; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 20; cursor: pointer;}
        .center-zero-btn:active { transform: scale(0.95); background: var(--border-main); }

        .score-text { font-family: 'IBM Plex Mono', monospace; font-weight: 700; color: var(--text-main); text-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .profit-positive { color: var(--color-p); }
        .profit-negative { color: var(--color-n); }
        .history-item { background: var(--input-bg); border: 1px solid var(--border-main); color: var(--text-main); }
        @keyframes border-pulse { 0% { box-shadow: 0 0 0 0 transparent; border-color: var(--color-a); } 50% { box-shadow: 0 0 20px 0px var(--color-a); } 100% { box-shadow: 0 0 0 0 transparent; border-color: var(--border-main); } }
        .border-pulse-anim { animation: border-pulse 0.6s ease-out; }
    </style>
</head>
<body class="obsidian-theme app-body">

    <!-- PIN Screen -->
    <div id="pin-overlay">
        <div class="text-center">
            <h2 class="text-2xl font-bold mb-2 tracking-widest opacity-80" style="color: white;">FEEDER ACCESS</h2>
            <div id="pin-status" class="text-blue-400 mb-6 text-xs font-mono opacity-70">CONNECTING...</div>
            <input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="••••" disabled>
            <div id="pin-error" class="text-red-500 mt-4 text-sm hidden font-bold">ACCESS DENIED</div>
        </div>
    </div>

    <div class="main-container">
        <!-- Main View -->
        <div id="main-view" class="view active">
            <header class="flex justify-between items-center h-20 flex-shrink-0 px-2">
                <button id="theme-switcher" class="icon-btn"></button>
                <div class="data-ring-container" id="data-ring">
                    <svg class="data-ring-svg" viewBox="0 0 36 36">
                        <path class="data-ring-circle ring-track" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                        <path id="ring-losses" class="data-ring-circle ring-losses" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                        <path id="ring-wins" class="data-ring-circle ring-wins" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                    </svg>
                    <div class="data-ring-text">
                        <div class="data-ring-total"><span class="value" id="trades-tracker">0</span></div>
                        <div class="data-ring-details">
                             <span class="profit-value" id="live-profit-detail"></span>
                             <div class="flex space-x-2 mt-1 text-[10px] font-bold opacity-70">
                                 <span id="wins-tracker-detail">W: 0</span>
                                 <span id="losses-tracker-detail">L: 0</span>
                             </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="text-center my-6 flex flex-col justify-center flex-grow">
                <h2 class="text-8xl score-text transition-all duration-200" id="main-score">0.00</h2>
            </div>
    
            <div class="mt-auto pb-4 px-2">
                <div class="flex items-center justify-center space-x-3 mb-6 px-2">
                    <select id="template-selector" class="dropdown font-bold"></select>
                    <button id="calc-btn" title="Edit History" class="btn btn-secondary !p-3"></button>
                    <button id="edit-templates-btn" class="btn btn-secondary !p-3">Edit</button>
                </div>
    
                <div id="buttons-container" class="grid grid-cols-3 gap-3 mb-6 px-1"></div>
                
                <div id="open-mode-container" class="open-mode-container hidden h-72 mb-4 px-2">
                    <div id="dial-negative" class="dial-track-container" style="border-color: var(--color-n);">
                        <div class="dial-value-display" style="color: var(--color-n);">0.00</div>
                        <div class="dial-handle"></div>
                    </div>
                    <button class="center-zero-btn" id="open-mode-zero-btn">0</button>
                    <div id="dial-positive" class="dial-track-container" style="border-color: var(--color-p);">
                        <div class="dial-value-display" style="color: var(--color-p);">0.00</div>
                        <div class="dial-handle"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 pt-4 border-t border-[var(--border-main)]">
                      <button id="undo-btn" class="btn btn-secondary flex justify-center items-center h-12"></button>
                      <button id="history-btn" class="btn btn-secondary flex justify-center items-center h-12"></button>
                      <button id="reset-btn" class="btn btn-secondary flex justify-center items-center h-12"></button>
                </div>
                
                <div class="pt-4">
                      <button id="save-btn" class="btn btn-action w-full py-3 text-lg shadow-lg">Save & Export Session</button>
                </div>
    
                <div id="saved-sessions-container" class="pt-4 space-y-2 hidden">
                    <div class="flex justify-between items-center border-b border-[var(--border-main)] pb-2">
                        <h3 class="text-sm font-bold uppercase tracking-wider opacity-70">Recent Exports</h3>
                        <button id="wipe-btn" title="Clear Visual Feed" class="icon-btn hover:text-red-400"></button>
                    </div>
                    <div id="sessions-log" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Edit Templates View -->
        <div id="edit-templates-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Edit Templates</h3>
                <button type="button" class="icon-btn close-view-btn"></button>
            </div>
            <div class="space-y-5 overflow-y-auto -mr-4 pr-4">
                <div><label class="text-xs uppercase font-bold opacity-60">Select Template</label><select id="template-edit-selector" class="form-input"></select></div>
                <div><label class="text-xs uppercase font-bold opacity-60">Name</label><input type="text" id="template-name-input" class="form-input"></div>
                
                <div class="flex items-center space-x-2 my-2 bg-[var(--input-bg)] p-3 rounded-lg border border-[var(--border-main)]">
                    <input type="checkbox" id="open-mode-checkbox" class="w-5 h-5 rounded border-gray-500 text-blue-600 focus:ring-blue-500">
                    <label for="open-mode-checkbox" class="text-sm font-bold">Enable OPEN Mode (Sliders)</label>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs uppercase font-bold opacity-60">Instrument</label><input type="text" id="instrument-input" class="form-input"></div>
                    <div><label class="text-xs uppercase font-bold opacity-60">Point Value</label><input type="number" id="point-value-input" class="form-input"></div>
                </div>
                <div><label class="text-xs uppercase font-bold opacity-60">Commission</label><input type="number" step="0.01" id="commission-input" class="form-input"></div>
                
                <div id="standard-inputs" class="space-y-4">
                    <div><label class="text-xs uppercase font-bold opacity-60">Positive Buttons</label><input type="text" id="positive-buttons-input" class="form-input" placeholder="e.g. 1, 2, 2.5"></div>
                    <div><label class="text-xs uppercase font-bold opacity-60">Negative Buttons</label><input type="text" id="negative-buttons-input" class="form-input" placeholder="e.g. -2, -5"></div>
                </div>

                <div id="open-mode-inputs" class="hidden space-y-4 border border-[var(--color-a)] p-4 rounded-lg bg-[var(--input-bg)]">
                    <div><label class="text-xs uppercase font-bold opacity-60">Increment Step</label><input type="number" id="increment-input" class="form-input" step="0.25"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs uppercase font-bold opacity-60">Max Pos</label><input type="number" id="max-pos-input" class="form-input"></div>
                        <div><label class="text-xs uppercase font-bold opacity-60">Max Neg</label><input type="number" id="max-neg-input" class="form-input"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-6 border-t border-[var(--border-main)]">
                    <button id="delete-template-btn" class="btn btn-negative-action text-xs px-3 py-2">Delete</button>
                    <div class="space-x-2">
                        <button type="button" class="btn btn-secondary close-view-btn">Close</button>
                        <button id="save-template-btn" class="btn btn-action">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Models View -->
        <div id="manage-models-view" class="view">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Manage Models</h3>
                <button type="button" class="icon-btn close-view-btn"></button>
            </div>
            <div class="space-y-4">
                 <div><label class="text-sm font-medium">New Model Details</label><input type="text" id="new-model-name" class="form-input" placeholder="Name"><input type="text" id="new-model-mgmt" class="form-input mt-2" placeholder="Management"><input type="text" id="new-model-ratio" class="form-input mt-2" placeholder="Ratio/Stop"><input type="text" id="new-model-exit" class="form-input mt-2" placeholder="Exit"><input type="text" id="new-model-instrument" class="form-input mt-2" placeholder="Instrument"></div>
                <button id="add-model-btn" class="btn btn-action w-full">Add Model</button>
                <div class="border-t border-gray-700 pt-4 mt-4"><h4 class="text-sm font-bold mb-2">Existing Models</h4><div id="models-list" class="space-y-2 text-xs max-h-48 overflow-y-auto"></div></div>
            </div>
        </div>

        <!-- Save View -->
        <div id="save-view" class="view">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Export to Cloud</h3>
                <button type="button" class="icon-btn close-view-btn"></button>
            </div>
            <div class="space-y-4">
                <div class="flex items-end space-x-2"><div class="flex-grow"><label for="save-model-selector" class="text-sm font-medium">Select Model</label><select id="save-model-selector" class="form-input"></select></div><button id="open-manage-models-btn" class="btn btn-secondary !p-2"></button></div>
                <div><label for="save-date" class="text-sm font-medium">Date</label><input type="date" id="save-date" class="form-input"></div>
                <div><label class="text-sm font-medium">Session Time</label><select id="session-time-selector" class="form-input"><option value="London (02:00 - 06:00)">London (02:00 - 06:00)</option><option value="Early (08:30 - 12:30)">Early (08:30 - 12:30)</option><option value="Late (12:30 - 15:00)">Late (12:30 - 15:00)</option><option value="Custom">Custom</option></select></div>
                <div id="custom-time-inputs" class="hidden grid grid-cols-2 gap-2"><div><label for="start-time" class="text-xs">Start</label><input type="time" id="start-time" class="form-input"></div><div><label for="end-time" class="text-xs">End</label><input type="time" id="end-time" class="form-input"></div></div>
                <div class="bg-[var(--input-bg)] p-3 rounded text-xs mt-4"><p class="font-bold mb-1 opacity-70">EXPORT PREVIEW</p><p>Uploading to App B Manager</p><p class="mt-1 text-xl font-bold" id="preview-pl">$0.00</p></div>
                <div class="flex justify-end space-x-2 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="confirm-save-btn" class="btn btn-action">Upload & Clear</button></div>
            </div>
        </div>

        <!-- Theme Selector View -->
        <div id="theme-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Select a Theme</h3>
                <button type="button" class="icon-btn close-view-btn"></button>
            </div>
            <div id="theme-grid" class="grid grid-cols-2 gap-4 overflow-y-auto -mr-4 pr-4"></div>
        </div>
        
        <!-- Other Views -->
        <div id="reset-view" class="view justify-center text-center"><div><h3 class="text-xl font-bold">Reset Session?</h3><p class="text-sm sub-text my-4">This will clear the current counts but NOT save them.</p><div class="flex justify-center space-x-4 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="confirm-reset-btn" class="btn btn-negative-action px-4 py-2">Reset</button></div></div></div>
        <div id="delete-template-view" class="view justify-center text-center"><div><h3 class="text-xl font-bold">Delete Template?</h3><p class="text-sm sub-text my-4">This cannot be undone.</p><div class="flex justify-center space-x-4 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="confirm-delete-template-btn" class="btn btn-negative-action px-4 py-2">Delete</button></div></div></div>
        <div id="wipe-all-view" class="view justify-center text-center"><div><h3 class="text-xl font-bold text-red-500">Wipe All History?</h3><p class="text-sm sub-text my-4">This will permanently delete ALL saved sessions from the global database.</p><div class="flex justify-center space-x-4 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="confirm-wipe-btn" class="btn btn-negative-action px-4 py-2">Wipe Everything</button></div></div></div>
        <div id="calc-view" class="view"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Edit Calculation</h3><button type="button" class="icon-btn close-view-btn"></button></div><p class="text-sm sub-text mb-2">Separate values with a space.</p><textarea id="calc-input" class="form-input h-24 flex-grow"></textarea><div class="flex justify-end space-x-2 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="update-calc-btn" class="btn btn-action">Update</button></div></div>
        <div id="restore-session-view" class="view justify-center text-center"><div><h3 class="text-xl font-bold">Unsaved Data</h3><p class="text-sm sub-text my-4">Restore previous incomplete session?</p><div class="flex justify-center space-x-4 mt-4"><button id="discard-session-btn" class="btn btn-secondary">Discard</button><button id="restore-session-btn" class="btn btn-action px-4 py-2">Restore</button></div></div></div>

        <div id="status-bar" class="text-xs text-center p-2 sub-text mt-auto font-bold opacity-60"></div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, onSnapshot, setDoc, addDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS ---
            const MASTER_KEY = "01512899027";
            const PIN_DOC_PATH = "settings/pin";
           const firebaseConfig = {
  apiKey: "AIzaSyBIlEbTnEzkcXJs0sRKOGx0xA5AWOWZdb4",
  authDomain: "tracker2026-330ca.firebaseapp.com",
  projectId: "tracker2026-330ca",
  storageBucket: "tracker2026-330ca.firebasestorage.app",
  messagingSenderId: "810324319247",
  appId: "1:810324319247:web:97ea4879073fc4f619577a"
};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-trading-ecosystem';
            
            // --- STATE ---
            let score = 0.00, wins = 0, losses = 0, totalTrades = 0, maxWin = 0, maxLoss = 0;
            let history = [], templates = {}, savedModels = [];
            let db, auth, templateToDeleteName = null, currentPin = "1234";
            let isAppUnlocked = false; 

            // --- DOM ELEMENTS ---
            const mainScoreEl = document.getElementById('main-score');
            const winsTrackerDetailEl = document.getElementById('wins-tracker-detail');
            const lossesTrackerDetailEl = document.getElementById('losses-tracker-detail');
            const tradesTrackerEl = document.getElementById('trades-tracker');
            const buttonsContainer = document.getElementById('buttons-container');
            const templateSelector = document.getElementById('template-selector');
            const themeSwitcher = document.getElementById('theme-switcher');
            const dataRingContainer = document.getElementById('data-ring');
            const ringWinsEl = document.getElementById('ring-wins');
            const ringLossesEl = document.getElementById('ring-losses');
            const liveProfitDetailEl = document.getElementById('live-profit-detail');
            const statusBar = document.getElementById('status-bar');
            const pinOverlay = document.getElementById('pin-overlay');
            const pinInput = document.getElementById('pin-input');
            
            // --- CONSTANTS ---
            const themeData = [
                { id: 'obsidian-theme', name: 'Obsidian', font: "'IBM Plex Mono', monospace", colors: { bg: '#111111', text: '#FFFFFF', border: '#333333', p: '#38BDF8', n: '#3F3F46', a: '#FFFFFF' }, btnText: '#000000' },
                { id: 'dark-theme', name: 'Dark', font: "'Poppins', sans-serif", colors: { bg: '#111111', text: '#F9FAFB', border: '#333', p: '#15803d', n: '#b91c1c', a: '#3b82f6' }, btnText: '#FFFFFF' },
                { id: 'ice-theme', name: 'Ice', font: "'Lato', sans-serif", colors: { bg: 'linear-gradient(to top, #f3e5f5, #e0f7fa)', text: '#2d3748', border: '#805ad5', p: '#3182ce', n: '#805ad5', a: '#805ad5' }, btnText: '#FFFFFF' },
                { id: 'sunrise-theme', name: 'Sunrise', font: "'Lato', sans-serif", colors: { bg: 'linear-gradient(to top, #D8B4FE, #FDE68A)', text: '#422006', border: '#F97316', p: '#F97316', n: '#581C87', a: '#854D0E' }, btnText: '#FFFFFF' },
                { id: 'cyberpunk-theme', name: 'Cyberpunk', font: "'Orbitron', sans-serif", colors: { bg: 'linear-gradient(to top, #2D0B5A, #0C1445)', text: '#A5F3FC', border: '#F472B6', p: '#22D3EE', n: '#F472B6', a: '#22D3EE' }, btnText: '#0C1445' },
                { id: 'forest-theme', name: 'Forest', font: "'Nunito', sans-serif", colors: { bg: 'linear-gradient(to top, #1E2A2A, #07373E)', text: '#EAE7E2', border: '#6EE7B7', p: '#6EE7B7', n: '#E57373', a: '#8D6E63' }, btnText: '#FFFFFF' },
                { id: 'crimson-theme', name: 'Crimson', font: "'Merriweather', serif", colors: { bg: 'linear-gradient(to top, #121212, #1C1C1C)', text: '#F5F5F5', border: '#DC2626', p: '#B91C1C', n: '#4B5563', a: '#D4AF37' }, btnText: '#1C1C1C' },
                { id: 'blueprint-theme', name: 'Blueprint', font: "'Roboto Mono', monospace", colors: { bg: '#0A2240', text: '#FFFFFF', border: '#7DD3FC', p: '#4ADE80', n: '#FACC15', a: '#7DD3FC' }, btnText: '#0A2240' },
                { id: 'monochrome-theme', name: 'Monochrome', font: "'Inter', sans-serif", colors: { bg: '#F3F4F6', text: '#111827', border: '#D1D5DB', p: '#111827', n: '#6B7280', a: '#111827' }, btnText: '#FFFFFF' },
                { id: 'oceanic-theme', name: 'Oceanic', font: "'Source Sans Pro', sans-serif", colors: { bg: 'linear-gradient(to top, #021024, #08203e)', text: '#E0E7FF', border: '#64ffda', p: '#FF7F50', n: '#4f8fc0', a: '#64ffda' }, btnText: '#021024' },
                { id: 'iridescent-theme', name: 'Iridescent', font: "'Poppins', sans-serif", colors: { bg: 'linear-gradient(45deg, #a7f3d0, #bae6fd, #fbcfe8, #fef08a)', text: '#581c87', border: '#d8b4fe', p: '#6ee7b7', n: '#fca5a5', a: '#c4b5fd' }, btnText: '#1f2937' },
                { id: 'nebula-theme', name: 'Nebula', font: "'Exo 2', sans-serif", colors: { bg: 'rgba(10, 10, 20, 0.7)', text: '#F0F9FF', border: '#A855F7', p: '#14B8A6', n: '#D946EF', a: '#6366F1' }, btnText: '#FFFFFF' },
                { id: 'midnight-bloom-theme', name: 'Midnight Bloom', font: "'DM Sans', sans-serif", colors: { bg: 'rgba(29, 26, 63, 0.5)', text: '#e0e7ff', border: '#f43f5e', p: '#22d3ee', n: '#f43f5e', a: '#a78bfa' }, btnText: '#1d1a3f' },
                { id: 'nocturne-theme', name: 'Nocturne', font: "'DM Sans', sans-serif", colors: { bg: 'rgba(10, 10, 10, 0.8)', text: '#E5E5E5', border: '#8B0000', p: '#006400', n: '#8B0000', a: '#4169E1' }, btnText: '#FFFFFF' },
                { id: 'sunrise-theme', name: 'Sunrise', font: "'Lato', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.65)', text: '#422006', border: '#F97316', p: '#F97316', n: '#581C87', a: '#854D0E' }, btnText: '#FFFFFF' }
        ];

        const defaultTemplates = { 
            "ES": { instrument: "ES", pointValue: 50, commission: 4.20, positive: [0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5], negative: [-2, -2.5, -3] },
            "NQ": { instrument: "NQ", pointValue: 20, commission: 4.20, positive: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], negative: [-4, -6, -8, -10] } 
        };

        // --- HELPER FUNCTIONS ---
        const setStatus = (msg, type = 'loading') => {
            if(!statusBar) return;
            statusBar.textContent = msg;
            statusBar.className = `text-xs text-center p-2 mt-auto font-bold ${type === 'error' ? 'text-red-400' : 'opacity-60'}`;
            if (type !== 'loading') setTimeout(() => statusBar.textContent = '', 3000);
        };

        const showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if (viewId === 'theme-view') updateThemeSelectionVisuals();
        };

        const applyTheme = (themeId) => {
            const theme = themeData.find(t => t.id === themeId);
            if(!theme) return;
            const root = document.documentElement;
            root.style.setProperty('--bg-main', theme.colors.bg);
            root.style.setProperty('--text-main', theme.colors.text);
            root.style.setProperty('--border-main', theme.colors.border);
            root.style.setProperty('--color-p', theme.colors.p);
            root.style.setProperty('--color-n', theme.colors.n);
            root.style.setProperty('--color-a', theme.colors.a);
            root.style.setProperty('--btn-text', theme.btnText || '#fff');
            root.style.setProperty('--font-main', theme.font);
            
            const isLight = ['ice-theme', 'sunrise-theme', 'monochrome-theme', 'crystal-clear-theme', 'aura-theme', 'iridescent-theme'].includes(themeId);
            if(isLight) {
                 root.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.6)');
                 root.style.setProperty('--input-bg', 'rgba(255, 255, 255, 0.8)');
                 root.style.setProperty('color-scheme', 'light');
            } else {
                 root.style.setProperty('--glass-bg', 'rgba(20, 20, 20, 0.7)');
                 root.style.setProperty('--input-bg', 'rgba(0, 0, 0, 0.4)');
                 root.style.setProperty('color-scheme', 'dark');
            }
            localStorage.setItem('appA_theme', themeId);
        };

        const updateThemeSelectionVisuals = () => {
            const current = localStorage.getItem('appA_theme') || 'obsidian-theme';
            document.querySelectorAll('.theme-card').forEach(card => card.classList.toggle('selected', card.dataset.theme === current));
        };

        const formatDate = (isoDate) => { 
            if (!isoDate) return ''; 
            const [y, m, d] = isoDate.split('-'); 
            return `${d}/${m}/${y}`; 
        };

        // --- UI RENDER LOGIC ---
        let currentAnimationInterval = null;

        const animateValue = (element, start, end, duration) => {
            if (currentAnimationInterval) clearInterval(currentAnimationInterval);
            if (start === end) {
                element.textContent = end.toFixed(2);
                return;
            }
            const startTime = new Date().getTime();
            
            currentAnimationInterval = setInterval(() => {
                const now = new Date().getTime();
                const progress = Math.min((now - startTime) / duration, 1);
                const val = start + ((end - start) * progress);
                element.textContent = val.toFixed(2);
                if (progress >= 1) {
                    clearInterval(currentAnimationInterval);
                    element.textContent = end.toFixed(2);
                }
            }, 20);
        };

        const updateDisplay = (previousScore = score) => {
            if (previousScore !== score) {
                animateValue(mainScoreEl, previousScore, score, 300);
                mainScoreEl.classList.add(score > 0 ? 'score-glow-positive' : 'score-glow-negative');
                setTimeout(() => mainScoreEl.classList.remove('score-glow-positive', 'score-glow-negative'), 500);
            } else { mainScoreEl.textContent = score.toFixed(2); }
            
            document.getElementById('wins-tracker-detail').textContent = `W: ${wins}`;
            document.getElementById('losses-tracker-detail').textContent = `L: ${losses}`;
            document.getElementById('trades-tracker').textContent = totalTrades;
            
            const currentTemplate = templates[document.getElementById('template-selector').value];
            if (totalTrades > 0 && currentTemplate?.pointValue != null) {
                const profit = (score * currentTemplate.pointValue) - (totalTrades * currentTemplate.commission);
                document.getElementById('live-profit-detail').textContent = `$${profit.toFixed(2)}`;
                document.getElementById('live-profit-detail').className = `profit-value ${profit >= 0 ? 'profit-positive' : 'profit-negative'}`;
            } else { document.getElementById('live-profit-detail').textContent = ''; }
            
            const winP = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const lossP = totalTrades > 0 ? (losses / totalTrades) * 100 : 0;
            document.getElementById('ring-wins').style.strokeDasharray = `${winP} ${100 - winP}`;
            document.getElementById('ring-losses').style.strokeDasharray = `${lossP} ${100 - lossP}`;
            document.getElementById('ring-losses').style.strokeDashoffset = -winP;
        };

        // OPEN MODE LOGIC
        const setupDials = (template) => {
             const posDial = document.getElementById('dial-positive');
             const negDial = document.getElementById('dial-negative');
             const zeroBtn = document.getElementById('open-mode-zero-btn');
             const increment = parseFloat(template.increment) || 0.25;
             const maxPos = parseFloat(template.maxPos) || 20;
             const maxNeg = parseFloat(template.maxNeg) || -10;

             const handleDialInteraction = (dialEl, isPositive, maxVal) => {
                const handle = dialEl.querySelector('.dial-handle');
                const display = dialEl.querySelector('.dial-value-display');
                const trackHeight = dialEl.offsetHeight;
                const handleHeight = handle.offsetHeight;
                const effectiveHeight = trackHeight - handleHeight - 20; 
                let isDragging = false, currentValue = 0;
                
                const updateVisuals = (clientY) => {
                    const rect = dialEl.getBoundingClientRect();
                    let relativeY = rect.bottom - clientY - (handleHeight/2) - 10; 
                    relativeY = Math.max(0, Math.min(relativeY, effectiveHeight));
                    const ratio = relativeY / effectiveHeight;
                    let rawValue = ratio * Math.abs(maxVal);
                    let snapped = Math.round(rawValue / increment) * increment;
                    if(Math.abs(snapped) > Math.abs(maxVal)) snapped = Math.abs(maxVal);
                    if(!isPositive) snapped = -snapped;
                    currentValue = snapped;
                    handle.style.bottom = `${10 + (ratio * effectiveHeight)}px`;
                    display.textContent = (currentValue > 0 ? '+' : '') + currentValue.toFixed(2);
                    dialEl.classList.add('active');
                };
                const startDrag = (e) => { isDragging = true; updateVisuals(e.touches ? e.touches[0].clientY : e.clientY); };
                const moveDrag = (e) => { if(!isDragging) return; updateVisuals(e.touches ? e.touches[0].clientY : e.clientY); };
                const endDrag = (e) => { if(!isDragging) return; isDragging = false; dialEl.classList.remove('active'); if(currentValue !== 0) handleButtonClick(e, currentValue); handle.style.bottom = '10px'; display.textContent = "0.00"; };
                dialEl.addEventListener('touchstart', startDrag, {passive: false});
                window.addEventListener('touchmove', moveDrag, {passive: false});
                window.addEventListener('touchend', endDrag);
                dialEl.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', moveDrag);
                window.addEventListener('mouseup', endDrag);
            };
            
            const newPos = posDial.cloneNode(true); const newNeg = negDial.cloneNode(true);
            posDial.parentNode.replaceChild(newPos, posDial); negDial.parentNode.replaceChild(newNeg, negDial);
            handleDialInteraction(newPos, true, maxPos); handleDialInteraction(newNeg, false, maxNeg);
            
            const newZero = zeroBtn.cloneNode(true); zeroBtn.parentNode.replaceChild(newZero, zeroBtn);
            newZero.onclick = (e) => handleButtonClick(e, 0);
        };

        const renderButtons = (templateName) => {
            const template = templates[templateName];
            if (!template) return;
            const btnContainer = document.getElementById('buttons-container');
            const openContainer = document.getElementById('open-mode-container');
            if (template.openMode) {
                btnContainer.classList.add('hidden');
                openContainer.classList.remove('hidden');
                setupDials(template);
            } else {
                openContainer.classList.add('hidden');
                btnContainer.classList.remove('hidden');
                btnContainer.innerHTML = '';
                const allButtons = [...(template.positive || []).sort((a, b) => a - b), 0, ...(template.negative || []).sort((a, b) => b - a)];
                allButtons.forEach(val => {
                    const btn = document.createElement('button');
                    btn.textContent = (val > 0 ? '+' : '') + (parseFloat(val) === parseInt(val) ? val : val.toFixed(1));
                    btn.className = `calc-btn ${val > 0 ? 'btn-positive' : val < 0 ? 'btn-negative-calc' : 'btn-neutral-calc'}`;
                    btn.onclick = (e) => handleButtonClick(e, val);
                    btnContainer.appendChild(btn);
                });
            }
        };

        const renderThemeSelector = () => {
            const grid = document.getElementById('theme-grid');
            grid.innerHTML = '';
            themeData.forEach(theme => {
                const card = document.createElement('div');
                card.className = 'theme-card';
                card.dataset.theme = theme.id;
                card.style.background = theme.colors.bg;
                card.style.color = theme.colors.text;
                card.innerHTML = `
                    <div class="checkmark-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg></div>
                    <div class="theme-card-header"><span class="theme-name-new" style="font-family: ${theme.font};">${theme.name}</span></div>
                    <div class="theme-swatches"><div class="swatch" style="background: ${theme.colors.p};"></div><div class="swatch" style="background: ${theme.colors.n};"></div><div class="swatch" style="background: ${theme.colors.a};"></div></div>`;
                grid.appendChild(card);
            });
        };

        const handleButtonClick = async (event, value) => {
            const prev = score;
            calculateState(value);
            const mainContainer = document.querySelector('.main-container');
            const color = value > 0 ? 'var(--color-p)' : (value < 0 ? 'var(--color-n)' : 'var(--color-a)');
            mainContainer.style.setProperty('--anim-color', color);
            mainContainer.classList.remove('border-pulse-anim');
            void mainContainer.offsetWidth;
            mainContainer.classList.add('border-pulse-anim');
            updateDisplay(prev);
            await autoSaveSession();
        };

        const resetCalculator = async () => {
            const prev = score;
            score = 0.00; wins = 0; losses = 0; totalTrades = 0; maxWin = 0; maxLoss = 0; history = [];
            updateDisplay(prev);
            if (isAppUnlocked) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appA_autosave', 'current'));
            showView('main-view'); // Fix: Close view on reset
        };

        const calculateState = (value) => {
            const prev = score;
            score = parseFloat((score + value).toFixed(2));
            history.push({ state: { score: prev, wins, losses, totalTrades, maxWin, maxLoss }, value });
            totalTrades++;
            if (value > 0) wins++;
            else if (value < 0) losses++;
            const currentTemplate = templates[templateSelector.value];
            if(currentTemplate) {
                 const profit = (score * currentTemplate.pointValue) - (totalTrades * currentTemplate.commission);
                 maxWin = Math.max(maxWin, profit);
                 maxLoss = Math.min(maxLoss, profit);
            }
        };

        const autoSaveSession = async () => {
            if (!isAppUnlocked) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'appA_autosave', 'current');
            await setDoc(ref, { score, wins, losses, totalTrades, maxWin, maxLoss, history, template: templateSelector.value });
        };

        const saveSessionToGlobal = async (data) => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'global_sessions'), {
                ...data,
                timestamp: new Date().toISOString()
            });
        };

        const saveModel = async (modelData) => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'global_models'), modelData);
        };

        const deleteTemplate = async (name) => {
             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'feeder_templates'));
             const snapshot = await getDocs(q);
             snapshot.forEach(async (d) => { if(d.data().name === name) await deleteDoc(d.ref); });
        };

        // --- INITIALIZATION ---
        window.initializeData = async () => {
            if(!auth || !db) return;
            setStatus('Loading...', 'loading');

            const templatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'feeder_templates');
            const tSnap = await getDocs(templatesRef);
            if (tSnap.empty) {
                for(const [name, data] of Object.entries(defaultTemplates)) { await addDoc(templatesRef, { name, ...data }); }
            }

            onSnapshot(templatesRef, (snap) => {
                templates = {};
                snap.forEach(doc => { templates[doc.data().name] = doc.data(); });
                const select = document.getElementById('template-selector');
                const editSelect = document.getElementById('template-edit-selector');
                const current = select.value;
                select.innerHTML = ''; editSelect.innerHTML = '<option value="" disabled selected>Select</option><option value="_new">-- Add New --</option>';
                Object.keys(templates).sort().forEach(name => { select.add(new Option(name, name)); editSelect.add(new Option(name, name)); });
                
                if (templates[current]) select.value = current;
                else if (Object.keys(templates).length > 0) select.value = Object.keys(templates)[0];
                
                renderButtons(select.value);
            });

            const modelsRef = collection(db, 'artifacts', appId, 'public', 'data', 'global_models');
            onSnapshot(modelsRef, (snap) => {
                const modelsList = document.getElementById('models-list');
                const saveSelector = document.getElementById('save-model-selector');
                modelsList.innerHTML = ''; saveSelector.innerHTML = '<option value="" disabled selected>Select Model</option>';
                snap.forEach(doc => {
                    const m = doc.data();
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-gray-700/30 rounded border border-gray-600 mb-1';
                    item.textContent = m.fullString; modelsList.appendChild(item);
                    saveSelector.add(new Option(m.fullString, m.fullString));
                });
            });
            
            const autoRef = doc(db, 'artifacts', appId, 'public', 'data', 'appA_autosave', 'current');
            const autoSnap = await getDoc(autoRef);
            if (autoSnap.exists()) {
                const d = autoSnap.data();
                document.getElementById('restore-session-btn').onclick = async () => {
                    score = d.score; wins = d.wins; losses = d.losses; totalTrades = d.totalTrades; maxWin = d.maxWin; maxLoss = d.maxLoss; history = d.history;
                    document.getElementById('template-selector').value = d.template;
                    renderButtons(d.template); updateDisplay(0);
                    await deleteDoc(autoRef); showView('main-view');
                };
                document.getElementById('discard-session-btn').onclick = async () => { await deleteDoc(autoRef); showView('main-view'); };
                showView('restore-session-view');
            }

            const sessionsRef = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_sessions'), orderBy('timestamp', 'desc'), limit(10));
            onSnapshot(sessionsRef, (snap) => {
                const log = document.getElementById('sessions-log');
                if (!log.classList.contains('visually-cleared')) {
                    log.innerHTML = '';
                    snap.forEach(d => {
                        const s = d.data();
                        const el = document.createElement('div');
                        el.className = 'history-item p-2 rounded-md mb-2';
                        const profit = (s.score * s.pointValue) - (s.totalTrades * (s.commission || 0));
                        el.innerHTML = `<div class="flex justify-between"><div><b>${s.date}</b><br><small>${s.modelName}</small></div><div class="text-right ${profit >= 0 ? 'text-green-400' : 'text-red-400'}">$${profit.toFixed(2)}</div></div>`;
                        log.appendChild(el);
                    });
                }
            });
            setStatus('Online', 'success');
        };

        // --- FIREBASE INIT ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        document.getElementById('pin-status').textContent = "Enter PIN";
                        pinInput.disabled = false; pinInput.focus();
                        const pinRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pin');
                        const pinSnap = await getDoc(pinRef);
                        if (pinSnap.exists()) { currentPin = pinSnap.data().code; }
                    }
                });
                
                pinInput.addEventListener('keyup', (e) => {
                    const val = pinInput.value;
                    if (val.length >= 4) {
                        if (val === currentPin || val === MASTER_KEY) {
                            isAppUnlocked = true;
                            pinOverlay.classList.add('hidden');
                            initializeData();
                        } else {
                            if(val.length > 11) pinInput.value = ''; 
                            if(val.length === 4 || val.length === 11) {
                                document.getElementById('pin-error').classList.remove('hidden');
                                setTimeout(() => document.getElementById('pin-error').classList.add('hidden'), 2000);
                                pinInput.value = '';
                            }
                        }
                    }
                });
                
                renderThemeSelector();
                applyTheme(localStorage.getItem('appA_theme') || 'obsidian-theme');

            } catch (e) {
                console.error("Init Error", e);
                setStatus('Connection Failed', 'error');
            }
        };

        // UI Event Handlers
        document.getElementById('theme-grid').addEventListener('click', (e) => {
            const card = e.target.closest('.theme-card');
            if (card) { applyTheme(card.dataset.theme); showView('main-view'); }
        });
        document.getElementById('theme-switcher').onclick = () => showView('theme-view');
        
        // Add listener for dropdown change
        document.getElementById('template-selector').addEventListener('change', (e) => {
            renderButtons(e.target.value);
        });

        document.getElementById('data-ring').onclick = () => document.getElementById('data-ring').classList.toggle('show-details');
        document.getElementById('history-btn').onclick = () => document.getElementById('saved-sessions-container').classList.toggle('hidden');
        document.querySelectorAll('.close-view-btn').forEach(b => b.onclick = () => showView('main-view'));
        
        // 2. Main Calc Actions
        document.getElementById('undo-btn').onclick = async () => { if (history.length) { const last = history.pop(); const prevScore = score; score = last.state.score; wins = last.state.wins; losses = last.state.losses; totalTrades = last.state.totalTrades; updateDisplay(prevScore); await autoSaveSession(); } };
        document.getElementById('reset-btn').onclick = () => showView('reset-view');
        document.getElementById('confirm-reset-btn').onclick = async () => { await resetCalculator(); }; // Fixed: Calls the updated function with showView
        
        // 3. Template & Model Actions
        document.getElementById('open-manage-models-btn').onclick = () => showView('manage-models-view'); // Fixed: Add Model button
        document.getElementById('edit-templates-btn').onclick = () => {
             // Reset inputs logic inline for simplicity
            document.getElementById('template-edit-selector').value = "";
            document.getElementById('template-name-input').value = "";
            document.getElementById('instrument-input').value = "ES";
            document.getElementById('point-value-input').value = "50";
            document.getElementById('commission-input').value = "1.24";
            document.getElementById('positive-buttons-input').value = "";
            document.getElementById('negative-buttons-input').value = "";
            
            const chk = document.getElementById('open-mode-checkbox');
            chk.checked = false;
            document.getElementById('standard-inputs').classList.remove('hidden');
            document.getElementById('open-mode-inputs').classList.add('hidden');
            document.getElementById('delete-template-btn').classList.add('hidden');
            showView('edit-templates-view');
        };
        
        const openModeCheckbox = document.getElementById('open-mode-checkbox');
        if(openModeCheckbox) {
            openModeCheckbox.addEventListener('change', () => {
                document.getElementById('standard-inputs').classList.toggle('hidden', openModeCheckbox.checked);
                document.getElementById('open-mode-inputs').classList.toggle('hidden', !openModeCheckbox.checked);
            });
        }
        
        const templateEditSelector = document.getElementById('template-edit-selector');
        if(templateEditSelector) {
            templateEditSelector.onchange = () => {
                const name = templateEditSelector.value;
                const t = templates[name];
                
                const setVal = (id, val) => document.getElementById(id).value = val;
                
                if(name === '_new' || !t) {
                    setVal('template-name-input', '');
                    setVal('instrument-input', '');
                    setVal('point-value-input', '');
                    setVal('commission-input', '');
                    setVal('positive-buttons-input', '');
                    setVal('negative-buttons-input', '');
                    openModeCheckbox.checked = false;
                    document.getElementById('standard-inputs').classList.remove('hidden');
                    document.getElementById('open-mode-inputs').classList.add('hidden');
                    document.getElementById('delete-template-btn').classList.add('hidden');
                } else {
                    setVal('template-name-input', name);
                    setVal('instrument-input', t.instrument);
                    setVal('point-value-input', t.pointValue);
                    setVal('commission-input', t.commission);
                    
                    if(t.openMode) {
                        openModeCheckbox.checked = true;
                        setVal('increment-input', t.increment);
                        setVal('max-pos-input', t.maxPos);
                        setVal('max-neg-input', t.maxNeg);
                        document.getElementById('standard-inputs').classList.add('hidden');
                        document.getElementById('open-mode-inputs').classList.remove('hidden');
                    } else {
                        openModeCheckbox.checked = false;
                        setVal('positive-buttons-input', (t.positive || []).join(', '));
                        setVal('negative-buttons-input', (t.negative || []).join(', '));
                        document.getElementById('standard-inputs').classList.remove('hidden');
                        document.getElementById('open-mode-inputs').classList.add('hidden');
                    }
                    document.getElementById('delete-template-btn').classList.remove('hidden');
                }
            };
        }

        document.getElementById('save-template-btn').onclick = async () => {
             const name = document.getElementById('template-name-input').value.trim();
            const instrument = document.getElementById('instrument-input').value.trim();
            const pointValue = parseFloat(document.getElementById('point-value-input').value);
            const commission = parseFloat(document.getElementById('commission-input').value);
            const isOpenMode = openModeCheckbox.checked;
            let templateData = { name, instrument, pointValue, commission, openMode: isOpenMode };
            
            if(!name || !instrument || isNaN(pointValue) || isNaN(commission)) { setStatus('All main fields are required', 'error'); return; }
            if (isOpenMode) {
                const inc = parseFloat(document.getElementById('increment-input').value);
                const mp = parseFloat(document.getElementById('max-pos-input').value);
                const mn = parseFloat(document.getElementById('max-neg-input').value);
                if(isNaN(inc) || isNaN(mp) || isNaN(mn)) { setStatus('Open Mode fields required', 'error'); return; }
                templateData.increment = inc; templateData.maxPos = mp; templateData.maxNeg = mn; templateData.positive = []; templateData.negative = [];
            } else {
                const pos = document.getElementById('positive-buttons-input').value.split(',').map(s=>parseFloat(s)).filter(n=>!isNaN(n));
                const neg = document.getElementById('negative-buttons-input').value.split(',').map(s=>parseFloat(s)).filter(n=>!isNaN(n));
                if(!pos.length) { setStatus('Buttons required', 'error'); return; }
                templateData.positive = pos; templateData.negative = neg;
            }
            const ref = collection(db, 'artifacts', appId, 'public', 'data', 'feeder_templates');
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'feeder_templates'));
            const snapshot = await getDocs(q);
            const existing = snapshot.docs.find(d => d.data().name === name);
            if (existing) await deleteDoc(existing.ref);
            await addDoc(ref, templateData);
            showView('main-view'); setStatus('Template Saved', 'success');
        };

        document.getElementById('delete-template-btn').onclick = () => {
            templateToDeleteName = document.getElementById('template-name-input').value;
            showView('delete-template-view');
        };

        document.getElementById('confirm-delete-template-btn').onclick = async () => {
            if(templateToDeleteName) {
                await deleteTemplate(templateToDeleteName);
                templateToDeleteName = null;
                showView('main-view');
                setStatus('Template Deleted', 'success');
            }
        };

        document.getElementById('add-model-btn').onclick = async () => {
            const name = document.getElementById('new-model-name').value;
            const mgmt = document.getElementById('new-model-mgmt').value;
            const ratio = document.getElementById('new-model-ratio').value;
            const exit = document.getElementById('new-model-exit').value;
            const inst = document.getElementById('new-model-instrument').value;
            if(!name) { setStatus('Name required', 'error'); return; }
            const fullString = `(${name} ${mgmt} ${ratio} ${exit} ${inst})`.toUpperCase();
            await saveModel({ name, mgmt, ratio, exit, inst, fullString });
            document.getElementById('new-model-name').value = '';
            setStatus('Model Added', 'success');
        };
        
        // 4. Save/Export Logic
        document.getElementById('save-btn').onclick = () => {
            document.getElementById('save-date').valueAsDate = new Date();
            const tmpl = templates[document.getElementById('template-selector').value];
            const profit = (score * tmpl.pointValue) - (totalTrades * tmpl.commission);
            document.getElementById('preview-pl').textContent = `$${profit.toFixed(2)}`;
            showView('save-view');
        };
        
        document.getElementById('confirm-save-btn').onclick = async () => {
            const model = document.getElementById('save-model-selector').value;
            const date = document.getElementById('save-date').value;
            let time = document.getElementById('session-time-selector').value;
            if(time === 'Custom') {
                const s = document.getElementById('start-time').value, e = document.getElementById('end-time').value;
                if(!s || !e) return; time = `${s} - ${e}`;
            }
            if(!date || !model) return;
            const tmpl = templates[document.getElementById('template-selector').value];
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'global_sessions'), {
                date, sessionTime: time, modelName: model, score, wins, losses, totalTrades, maxWin, maxLoss,
                instrument: tmpl.instrument, pointValue: tmpl.pointValue, commission: tmpl.commission || 0,
                hidden: false, timestamp: new Date().toISOString()
            });
            await resetCalculator();
            setStatus('Uploaded & Cleared', 'success');
            showView('main-view');
        };
        
        // 5. Misc
        document.getElementById('wipe-btn').onclick = () => { const log = document.getElementById('sessions-log'); log.innerHTML = ''; log.classList.add('visually-cleared'); setStatus('Feed Cleared (Data Safe)', 'success'); };
        document.getElementById('calc-btn').onclick = () => { document.getElementById('calc-input').value = history.map(h => h.value || 0).join(' '); showView('calc-view'); };
        document.getElementById('update-calc-btn').onclick = async () => {
            const values = document.getElementById('calc-input').value.trim().split(' ').map(Number).filter(n => !isNaN(n));
            score = 0; wins = 0; losses = 0; totalTrades = 0; history = [];
            for (const val of values) calculateState(val);
            updateDisplay(0); await autoSaveSession(); showView('main-view');
        };

        // --- INJECT ICONS ---
        // (Icons are injected in initialization to ensure instant visual load)
        const svgClose = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;
        document.querySelectorAll('.close-view-btn').forEach(btn => btn.innerHTML = svgClose);
        document.getElementById('theme-switcher').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/><path d="M16 8c0 3.15-1.866 5.959-4.573 7.164a.5.5 0 1 1-.457-.894A7.002 7.002 0 0 0 15 8a.5.5 0 0 1 1 0z"/></svg>`;
        document.getElementById('undo-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>`;
        document.getElementById('history-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zM11.985 1.795a7.002 7.002 0 0 0-3.582-1.795l.074-.997a8.001 8.001 0 0 1 4.09 2.025l-.71.71A7.001 7.001 0 0 0 11.985 1.795zM4.015 1.795a7.002 7.002 0 0 0-3.582 1.795l.71.71a7.001 7.001 0 0 0 3.582-1.795L4.015 1.795zM1.795 4.015a7.002 7.002 0 0 0-1.795 3.582l.997.074a7.001 7.001 0 0 0 1.795-3.582l-.997-.074zM14.205 4.015a7.002 7.002 0 0 0-1.795-3.582l-.71.71a7.001 7.001 0 0 0 1.795 3.582l.997-.074zM8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 1a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/><path d="M8 5.5a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/></svg>`;
        document.getElementById('reset-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>`;
        document.getElementById('open-manage-models-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>`;
        document.getElementById('calc-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/><path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/></svg>`; 
        document.getElementById('wipe-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/></svg>`;

        initFirebase();
    });
    </script>
</body>
</html>
